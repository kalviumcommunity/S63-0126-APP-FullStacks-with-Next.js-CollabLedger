# PR: Add authentication APIs, DB update, smoke tests, and docs

**Summary**

Adds secure authentication endpoints (signup, login, protected), safely updates the database to store hashed passwords, provides smoke tests and helper scripts, and documents the changes.

---

## What I changed

- **APIs**
  - `app/api/auth/signup/route.ts` — Sign up (name, email, password). Hashes password with bcrypt and stores user via Prisma.
  - `app/api/auth/login/route.ts` — Login (email, password). Verifies password and returns a JWT (payload: `id`, `email`, expiry: 1h).
  - `app/api/users/route.ts` — Protected endpoint. Verifies `Authorization: Bearer <token>` and returns decoded payload.

- **Database / Prisma**
  - `prisma/schema.prisma` — `User` model updated: added optional `password` field to avoid destructive schema changes.
  - `scripts/add-password-column.mjs` — raw-SQL helper that adds a nullable `password` column when direct migrations are unsafe.
  - Ran `npx prisma generate` to regenerate the client.

- **Tests & tooling**
  - `scripts/smoke-test.mjs` — smoke-test script: signup → login → users to verify the flow locally.
  - `src/types/custom.d.ts` — temporary module declarations for `bcrypt` and `jsonwebtoken` to avoid local peer-install conflicts.

- **Docs**
  - `README.md` — appended **Authentication APIs** section with commands and notes.

---

## Motivation

Provide production-minded authentication endpoints for the App Router using best practices:
- Environment-configured `JWT_SECRET`
- bcrypt password hashing (10 rounds)
- JWT expiry (1 hour)
- Minimal token payload

Existing databases were preserved by introducing `password` as nullable and adding it via a safe SQL script rather than forcing a destructive migration.

---

## How to test locally (repro steps)

1. Ensure `.env` contains `DATABASE_URL` and `JWT_SECRET`.
2. Start dev server (example, Windows cmd):
```bash
set "JWT_SECRET=your_secret_here" && npm run dev
```
3. (If DB lacks `password`) add the column once:
```bash
node scripts/add-password-column.mjs
```
4. Run smoke tests in a separate terminal:
```bash
node scripts/smoke-test.mjs
```
Expected: signup (201 or 409 if user already exists), login (200 + token), users (200 + decoded payload).

Optional verification:
```bash
npx tsc --noEmit
npx prisma generate
```

---

## Files changed / added

- API routes
  - `app/api/auth/signup/route.ts`
  - `app/api/auth/login/route.ts`
  - `app/api/users/route.ts`
- Prisma
  - `prisma/schema.prisma`
- Scripts
  - `scripts/add-password-column.mjs`
  - `scripts/smoke-test.mjs`
- Types
  - `src/types/custom.d.ts` (temporary)
- Docs
  - `README.md` (Authentication APIs section)

---

## DB / Migration notes

- The `password` column was added as nullable to avoid destructive migrations against existing data.
- If you want `password` required later: seed/set passwords for existing users, update `schema.prisma` to `password String`, and create a migration (`npx prisma migrate dev`).

---

## Security notes

- `JWT_SECRET` must be set in the environment and never committed.
- Passwords are hashed using bcrypt with 10 salt rounds.
- JWT payload includes only `id` and `email`; expiry = 1 hour.
- Remove or restrict any debug logging before production.

---

## Dev / CI caveats

- Temporary `src/types/custom.d.ts` was added because installing `@types/bcrypt` / `@types/jsonwebtoken` caused peer-resolution errors in this environment. For stricter typing, install the `@types/*` packages and remove the temporary declarations:
```bash
npm install --save-dev @types/bcrypt @types/jsonwebtoken
# then remove src/types/custom.d.ts
```
- Husky + lint-staged may fail locally with ESLint/peer-version mismatches. If CI linting fails, try:
```bash
npm install --legacy-peer-deps
npx eslint src --ext .ts,.tsx,.js,.jsx
```

---

## Checklist (before merge)

- [x] APIs implemented and smoke-tested locally
- [x] Prisma client regenerated
- [x] README updated with commands and notes
- [x] DB column added safely via script
- [ ] Remove `src/types/custom.d.ts` and install proper `@types/*` (optional)
- [ ] Ensure CI linting passes (resolve ESLint config / dependency mismatches)
- [ ] Add migration to make `password` required (if desired) after seeding existing users

---

If you'd like, I can also:
- Draft the PR body in the GitHub format with labels and checklist prefilled.
- Add a minimal `/signup` frontend page and link it in the README.
- Add an admin endpoint or script to set passwords for existing users so the column can be made required.

---

_Generated by the authentication feature work — paste this content into the GitHub PR description when creating the PR._
